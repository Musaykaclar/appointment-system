@using MudBlazor
@using AppointmentSystem.Application.DTOs
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Randevu Reddet</MudText>
    </TitleContent>
    <DialogContent>
        <MudText Typo="Typo.body1" Class="mb-3">
            <strong>@Appointment?.Title</strong> başlıklı randevuyu reddetmek için lütfen bir açıklama giriniz.
        </MudText>
        <MudTextField @bind-Value="RejectComment" 
                     Label="Red Nedeni*" 
                     Variant="Variant.Outlined"
                     Lines="3"
                     Required="true"
                     RequiredError="Red nedeni zorunludur" />
    </DialogContent>
    <DialogActions>
        <MudButton ButtonType="ButtonType.Button" OnClick="Cancel">İptal</MudButton>
        <MudButton ButtonType="ButtonType.Button" 
                  Color="Color.Error" 
                  Variant="Variant.Filled" 
                  OnClick="@(async () => await HandleRejectClick())"
                  Disabled="@string.IsNullOrWhiteSpace(RejectComment)">
            Reddet
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IDialogReference? MudDialog { get; set; }

    [Parameter] public AppointmentDto? Appointment { get; set; }

    private string RejectComment { get; set; } = string.Empty;

    private async Task HandleRejectClick()
    {
        // Önce console log yaz
        var appointmentInfo = Appointment != null 
            ? $"Randevu ID: {Appointment.Id}, Başlık: {Appointment.Title}" 
            : "Randevu bilgisi yok";
        
        var logMessage = $"[REJECT DIALOG BUTTON] Reddet butonuna basıldı - {appointmentInfo}, Red Nedeni: {RejectComment}";
        
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", logMessage);
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"Console log hatası: {ex.Message}");
        }
        
        // Sonra Submit metodunu çağır
        await Submit();
    }

    private async Task Submit()
    {
        if (string.IsNullOrWhiteSpace(RejectComment))
        {
            await JSRuntime.InvokeVoidAsync("console.log", "[REJECT DIALOG] Submit başarısız - Comment empty");
            return;
        }

        // Console log ekle
        var appointmentInfo = Appointment != null 
            ? $"Randevu ID: {Appointment.Id}, Başlık: {Appointment.Title}" 
            : "Randevu bilgisi yok";
        
        var logMessage = $"[REJECT DIALOG] Submit metodu çağrıldı - {appointmentInfo}, Red Nedeni: {RejectComment}";
        
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", logMessage);
        }
        catch
        {
            // Hata durumunda sessizce devam et
        }
        
        // Dialog'u kapat
        if (MudDialog != null)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("console.log", "[REJECT DIALOG] MudDialog.Close çağrılıyor...");
                MudDialog.Close(DialogResult.Ok(RejectComment));
                await JSRuntime.InvokeVoidAsync("console.log", "[REJECT DIALOG] MudDialog.Close çağrıldı");
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("console.log", $"[REJECT DIALOG] MudDialog.Close hatası: {ex.Message}");
            }
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("console.log", "[REJECT DIALOG] MudDialog null!");
        }
    }

    private void Cancel() 
    {
        MudDialog?.Close(DialogResult.Cancel());
    }
}

