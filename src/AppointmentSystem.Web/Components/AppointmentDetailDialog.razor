@using MudBlazor
@using AppointmentSystem.Domain.Entities
@using AppointmentSystem.Application.DTOs
@using AppointmentSystem.Application.Services
@using Microsoft.AspNetCore.Components
@inject IAppointmentService AppointmentService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Randevu Detayları</MudText>
    </TitleContent>
    <DialogContent>
        @if (CurrentAppointment != null)
        {
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Talep No</MudText>
                    <MudText>@CurrentAppointment.Id</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Başlık</MudText>
                    <MudText>@CurrentAppointment.Title</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Talep Eden</MudText>
                    <MudText>@CurrentAppointment.RequestedBy</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Şube</MudText>
                    <MudText>@CurrentAppointment.BranchName</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Tarih</MudText>
                    <MudText>@CurrentAppointment.Date.ToShortDateString()</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Saat</MudText>
                    <MudText>@CurrentAppointment.StartTime.ToString(@"hh\:mm") - @CurrentAppointment.EndTime.ToString(@"hh\:mm")</MudText>
                </MudItem>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Primary">Durum</MudText>
                    <MudChip T="string" Color="@GetStatusColor(CurrentAppointment.Status)" Size="Size.Medium" Variant="Variant.Filled">
                        @GetStatusText(CurrentAppointment.Status)
                    </MudChip>
                </MudItem>
                @if (!string.IsNullOrEmpty(CurrentAppointment.Description))
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary">Açıklama</MudText>
                        <MudText>@CurrentAppointment.Description</MudText>
                    </MudItem>
                }
                @if (!string.IsNullOrEmpty(CurrentAppointment.AdminComment))
                {
                    <MudItem xs="12">
                        <MudText Typo="Typo.subtitle2" Color="Color.Primary">Yönetici Yorumu</MudText>
                        <MudText>@CurrentAppointment.AdminComment</MudText>
                    </MudItem>
                }
            </MudGrid>

            <MudDivider Class="my-4" />

            <MudText Typo="Typo.h6" Class="mb-3">Durum Geçmişi</MudText>
            @if (Audits != null && Audits.Any())
            {
                <MudTimeline>
                    @foreach (var audit in Audits)
                    {
                        <MudTimelineItem Size="Size.Small" Color="@GetAuditColor(audit.ToStatus)">
                            <MudText Typo="Typo.body2">
                                <strong>@GetStatusText(audit.FromStatus)</strong> → <strong>@GetStatusText(audit.ToStatus)</strong>
                            </MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                @audit.ActionBy - @audit.ActionAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")
                            </MudText>
                            @if (!string.IsNullOrEmpty(audit.Comment))
                            {
                                <MudPaper Elevation="0" Class="pa-2 mt-2" Style="background-color: #f5f5f5;">
                                    <MudText Typo="Typo.body2">@audit.Comment</MudText>
                                </MudPaper>
                            }
                        </MudTimelineItem>
                    }
                </MudTimeline>
            }
            else
            {
                <MudAlert Severity="Severity.Info">
                    Henüz durum değişikliği yok.
                </MudAlert>
            }
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Kapat</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IDialogReference? MudDialog { get; set; }

    [Parameter] public AppointmentDto? Appointment { get; set; }

    private List<AppointmentAuditDto> Audits { get; set; } = new();
    private AppointmentDto? CurrentAppointment { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadAppointmentData();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadAppointmentData();
    }

    private async Task LoadAppointmentData()
    {
        if (Appointment != null)
        {
            // Randevu bilgilerini yeniden yükle (durum güncellemeleri için)
            var updatedAppointment = await AppointmentService.GetAppointmentByIdAsync(Appointment.Id);
            if (updatedAppointment != null)
            {
                CurrentAppointment = updatedAppointment;
            }
            else
            {
                CurrentAppointment = Appointment;
            }

            // Audit kayıtlarını yükle
            Audits = await AppointmentService.GetAppointmentAuditsAsync(Appointment.Id);
            StateHasChanged();
        }
    }

    private Color GetStatusColor(AppointmentSystem.Domain.Entities.AppointmentStatus status)
    {
        return status switch
        {
            AppointmentSystem.Domain.Entities.AppointmentStatus.Draft => Color.Default,
            AppointmentSystem.Domain.Entities.AppointmentStatus.Pending => Color.Warning,
            AppointmentSystem.Domain.Entities.AppointmentStatus.Approved => Color.Success,
            AppointmentSystem.Domain.Entities.AppointmentStatus.Rejected => Color.Error,
            _ => Color.Default
        };
    }

    private string GetStatusText(AppointmentSystem.Domain.Entities.AppointmentStatus status)
    {
        return status switch
        {
            AppointmentSystem.Domain.Entities.AppointmentStatus.Draft => "Taslak",
            AppointmentSystem.Domain.Entities.AppointmentStatus.Pending => "Beklemede",
            AppointmentSystem.Domain.Entities.AppointmentStatus.Approved => "Onaylandı",
            AppointmentSystem.Domain.Entities.AppointmentStatus.Rejected => "Reddedildi",
            _ => status.ToString()
        };
    }

    private Color GetAuditColor(AppointmentSystem.Domain.Entities.AppointmentStatus status)
    {
        return status switch
        {
            AppointmentSystem.Domain.Entities.AppointmentStatus.Approved => Color.Success,
            AppointmentSystem.Domain.Entities.AppointmentStatus.Rejected => Color.Error,
            _ => Color.Info
        };
    }

    void Cancel() 
    {
        MudDialog?.Close();
    }
}

