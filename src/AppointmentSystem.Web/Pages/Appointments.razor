@page "/appointments"
@using AppointmentSystem.Application.DTOs
@using AppointmentSystem.Application.Services
@using AppointmentSystem.Domain.Entities
@using AppointmentSystem.Web.Services
@using MudBlazor
@inject IAppointmentService AppointmentService
@inject IBranchService BranchService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthStateService AuthState
@inject NavigationManager Navigation

<PageTitle>Randevu Listesi</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudPaper Elevation="2" Class="pa-4 rounded-lg">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <MudText Typo="Typo.h5" GutterBottom="false">Randevularım</MudText>
            <div class="d-flex align-items-center">
                <MudButton Color="Color.Default" 
                           Variant="Variant.Outlined" 
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="RefreshAppointments"
                           Disabled="@IsLoading"
                           Class="me-2"
                           title="Yenile">
                    Yenile
                </MudButton>
                <MudButton Color="Color.Primary" 
                           Variant="Variant.Filled" 
                           StartIcon="@Icons.Material.Filled.Add"
                           Href="/appointment-form">
                    Yeni Randevu
                </MudButton>
            </div>
        </div>

        <AppointmentFilterPanel Filter="@Filter" 
                                Branches="@Branches" 
                                ShowStatusSort="true"
                                OnFilterChanged="ApplyFilters"
                                OnClearFilters="ClearFilters" />

        <AppointmentTable Appointments="@PagedResult.Items"
                          IsLoading="@IsLoading"
                          PageSize="@(Filter.PageSize ?? 10)"
                          CurrentPage="@(Filter.PageNumber ?? 1)"
                          TotalCount="@PagedResult.TotalCount"
                          OnPageChanged="@(async (int page) => await OnPageChanged(page))"
                          OnPageSizeChanged="@(async (int pageSize) => await OnPageSizeChanged(pageSize))"
                          ShowRequestedBy="true"
                          OnShowDetails="@(async (appointment) => await ShowDetails(appointment))" />

        @if (!PagedResult.Items.Any() && !IsLoading)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">
                Randevu bulunamadı. Yeni randevu oluşturmak için "Yeni Randevu" butonuna tıklayın.
            </MudAlert>
        }

    </MudPaper>

</MudContainer>

@code {
    private AppointmentFilterDto Filter = new() { PageSize = 10 };
    private PagedResult<AppointmentDto> PagedResult = new();
    private bool IsLoading = false;
    private List<BranchDto> Branches = new();

    protected override async Task OnInitializedAsync()
    {
        // Initialization'ı bekle
        await AuthState.WaitForInitializationAsync();
        
        // Login kontrolü
        if (!AuthState.IsAuthenticated)
        {
            Navigation.NavigateTo("/login");
            return;
        }

        // Yönetici bu sayfaya erişemez
        if (AuthState.IsAdmin)
        {
            Snackbar.Add("Yöneticiler bu sayfaya erişemez!", Severity.Warning);
            Navigation.NavigateTo("/admin-appointments");
            return;
        }

        try
        {
            Branches = await BranchService.GetAllBranchesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Şubeler yüklenirken hata oluştu: {ex.Message}", Severity.Warning);
        }
        await LoadAppointments();
    }

    private async Task LoadAppointments()
    {
        IsLoading = true;
        StateHasChanged();
        try
        {
            // Kullanıcı sadece kendi randevularını görsün (admin değilse)
            if (!AuthState.IsAdmin && AuthState.CurrentUser != null)
            {
                Filter.RequestedById = AuthState.CurrentUser.Id;
            }
            else
            {
                Filter.RequestedById = null; // Admin tüm randevuları görsün
            }
            
            PagedResult = await AppointmentService.GetAppointmentsAsync(Filter);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task ApplyFilters()
    {
        Filter.PageNumber = 1;
        await LoadAppointments();
    }

    private async Task ClearFilters()
    {
        Filter = new AppointmentFilterDto { PageSize = 10 };
        await LoadAppointments();
    }

    private async Task OnPageChanged(int page)
    {
        Filter.PageNumber = page;
        await LoadAppointments();
    }

    private async Task OnPageSizeChanged(int pageSize)
    {
        Filter.PageSize = pageSize;
        Filter.PageNumber = 1;
        await LoadAppointments();
    }


    private async Task ShowDetails(AppointmentDto appointment)
    {
        var parameters = new DialogParameters
        {
            ["Appointment"] = appointment
        };

        var options = new DialogOptions() 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AppointmentDetailDialog>("Randevu Detayları", parameters, options);
        var result = await dialog.Result;
        
        // Dialog kapandıktan sonra listeyi yenile (durum değişiklikleri için)
        if (result != null && !result.Canceled)
        {
            await RefreshAppointments();
        }
    }

    private async Task RefreshAppointments()
    {
        await LoadAppointments();
        Snackbar.Add("Randevu listesi yenilendi", Severity.Info);
    }
}
