@page "/admin-appointments"
@using AppointmentSystem.Application.DTOs
@using AppointmentSystem.Application.Services
@using AppointmentSystem.Domain.Entities
@using AppointmentSystem.Web.Services
@using AppointmentSystem.Web.Helpers
@using MudBlazor
@using Microsoft.JSInterop
@inject IAppointmentService AppointmentService
@inject IBranchService BranchService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthStateService AuthState
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<PageTitle>Yönetici Paneli</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudPaper Elevation="2" Class="pa-4 rounded-lg">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <MudText Typo="Typo.h5" GutterBottom="false">Yönetici Paneli</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Randevu taleplerini görüntüleyin, onaylayın veya reddedin</MudText>
            </div>
            <MudChip T="string" Color="@AppointmentStatusHelper.GetStatusChipColor(Filter.Status)" Size="Size.Medium" Variant="Variant.Filled">
                @PagedResult.TotalCount @AppointmentStatusHelper.GetStatusChipText(Filter.Status)
            </MudChip>
        </div>

        <AppointmentFilterPanel Filter="@Filter" 
                                Branches="@Branches" 
                                UseStringStatusFilter="true"
                                OnFilterChanged="ApplyFilters"
                                OnClearFilters="ClearFilters" />

        <AppointmentTable Appointments="@PagedResult.Items"
                          IsLoading="@IsLoading"
                          PageSize="@(Filter.PageSize ?? 10)"
                          CurrentPage="@(Filter.PageNumber ?? 1)"
                          TotalCount="@PagedResult.TotalCount"
                          OnPageChanged="@(async (int page) => await OnPageChanged(page))"
                          OnPageSizeChanged="@(async (int pageSize) => await OnPageSizeChanged(pageSize))"
                          ShowRequestedBy="true"
                          ShowRequestedByAsChip="true"
                          ShowDescription="true"
                          ShowDateBeforeBranch="true"
                          ShowApproveRejectButtons="true"
                          OnApprove="@(async (appointment) => await ApproveAppointment(appointment))"
                          OnReject="@(async (appointment) => await RejectAppointment(appointment))"
                          OnShowDetails="@(async (appointment) => await ShowDetails(appointment))" />

        @if (!PagedResult.Items.Any() && !IsLoading)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">
                @if (Filter.Status == AppointmentStatus.Pending)
                {
                    <text>Tüm randevu talepleri işlendi. Bekleyen talep bulunmamaktadır.</text>
                }
                else if (Filter.Status.HasValue)
                {
                    <text>Seçilen duruma göre randevu bulunamadı.</text>
                }
                else
                {
                    <text>Randevu bulunamadı.</text>
                }
            </MudAlert>
        }

    </MudPaper>

</MudContainer>

@code {
    private AppointmentFilterDto Filter = new() { PageSize = 10, Status = AppointmentStatus.Pending };
    private PagedResult<AppointmentDto> PagedResult = new();
    private bool IsLoading = false;
    private List<BranchDto> Branches = new();

    protected override async Task OnInitializedAsync()
    {
        // Initialization'ı bekle
        await AuthState.WaitForInitializationAsync();
        
        // Admin kontrolü
        if (!AuthState.IsAuthenticated || !AuthState.IsAdmin)
        {
            Snackbar.Add("Bu sayfaya erişim yetkiniz yok!", Severity.Error);
            if (AuthState.IsAuthenticated)
            {
                Navigation.NavigateTo("/appointments");
            }
            else
            {
                Navigation.NavigateTo("/login");
            }
            return;
        }

        try
        {
            Branches = await BranchService.GetAllBranchesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Şubeler yüklenirken hata oluştu: {ex.Message}", Severity.Warning);
        }
        await LoadAppointments();
    }

    private async Task LoadAppointments()
    {
        IsLoading = true;
        StateHasChanged();
        try
        {
            // Eğer durum filtresi yoksa veya Pending ise, tüm randevuları göster
            // Aksi halde seçilen duruma göre filtrele
            if (Filter.Status == null || Filter.Status == AppointmentStatus.Pending)
            {
                // Pending durumu için özel metod kullan (varsayılan davranış)
                if (Filter.Status == AppointmentStatus.Pending)
                {
                    PagedResult = await AppointmentService.GetPendingAppointmentsAsync(Filter);
                }
                else
                {
                    // Tümü seçildiğinde tüm randevuları göster
                    PagedResult = await AppointmentService.GetAppointmentsAsync(Filter);
                }
            }
            else
            {
                // Approved veya Rejected durumu için normal filtreleme kullan
                PagedResult = await AppointmentService.GetAppointmentsAsync(Filter);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task ApplyFilters()
    {
        Filter.PageNumber = 1;
        await LoadAppointments();
    }

    private async Task ClearFilters()
    {
        Filter = new AppointmentFilterDto { PageSize = 10 };
        await LoadAppointments();
    }

    private async Task OnPageChanged(int page)
    {
        Filter.PageNumber = page;
        await LoadAppointments();
    }

    private async Task OnPageSizeChanged(int pageSize)
    {
        Filter.PageSize = pageSize;
        Filter.PageNumber = 1;
        await LoadAppointments();
    }

    private async Task ApproveAppointment(AppointmentDto appointment)
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["Message"] = $"'{appointment.Title}' başlıklı randevuyu onaylamak istediğinizden emin misiniz?",
                ["ConfirmText"] = "Onayla",
                ["CancelText"] = "İptal"
            };

            var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
            var dialog = await DialogService.ShowAsync<ConfirmDialog>("Onay", parameters, options);
            
            // Console log ekle
            await JSRuntime.InvokeVoidAsync("console.log", "[APPROVE] Dialog açıldı, result bekleniyor...");
            
            DialogResult? result = null;
            bool dialogConfirmed = false;
            
            try
            {
                result = await dialog.Result;
                await JSRuntime.InvokeVoidAsync("console.log", $"[APPROVE] Dialog result alındı - Canceled: {result?.Canceled}, Data: {result?.Data}, Data Type: {result?.Data?.GetType()?.Name}");
                System.Diagnostics.Debug.WriteLine($"[APPROVE] Dialog result alındı - Canceled: {result?.Canceled}, Data: {result?.Data}, Data Type: {result?.Data?.GetType()?.Name}");
                
                // Result kontrolü
                if (result != null && !result.Canceled)
                {
                    if (result.Data is bool confirmed)
                    {
                        dialogConfirmed = confirmed;
                    }
                    else
                    {
                        // Data bool değilse de onaylanmış say (MudBlazor bazen farklı dönebilir)
                        dialogConfirmed = true;
                    }
                }
            }
            catch (OperationCanceledException)
            {
                // Dialog iptal edildi, sessizce çık
                await JSRuntime.InvokeVoidAsync("console.log", "[APPROVE] Dialog iptal edildi (OperationCanceledException)");
                System.Diagnostics.Debug.WriteLine("[APPROVE] Dialog iptal edildi (OperationCanceledException)");
                return;
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("console.log", $"[APPROVE] Dialog exception: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"[APPROVE] Dialog exception: {ex.Message}");
                Snackbar.Add($"Dialog hatası: {ex.Message}", Severity.Error);
                return;
            }

            await JSRuntime.InvokeVoidAsync("console.log", $"[APPROVE] Dialog confirmed: {dialogConfirmed}");

            // Dialog onaylandıysa API çağrısını yap
            if (dialogConfirmed)
            {
                await JSRuntime.InvokeVoidAsync("console.log", "[APPROVE] Dialog onaylandı, API çağrısı yapılıyor...");
                
                IsLoading = true;
                StateHasChanged();
                
                try
                {
                    var adminName = AuthState.CurrentUser?.FullName ?? AuthState.CurrentUser?.Username ?? "Admin";
                    System.Diagnostics.Debug.WriteLine($"[APPROVE] Admin name: {adminName}, Appointment ID: {appointment.Id}");
                    
                    // Mevcut durumu kontrol et
                    var currentAppointment = await AppointmentService.GetAppointmentByIdAsync(appointment.Id);
                    if (currentAppointment == null)
                    {
                        Snackbar.Add("Randevu bulunamadı!", Severity.Error);
                        await LoadAppointments();
                        return;
                    }

                    System.Diagnostics.Debug.WriteLine($"[APPROVE] Mevcut durum: {currentAppointment.Status}");

                    // API çağrısını yap
                    try
                    {
                        System.Diagnostics.Debug.WriteLine($"[APPROVE] API çağrısı başlatılıyor...");
                        await AppointmentService.ApproveAppointmentAsync(appointment.Id, adminName);
                        System.Diagnostics.Debug.WriteLine($"[APPROVE] API çağrısı başarılı - Randevu ID: {appointment.Id}");
                    }
                    catch (Exception apiEx)
                    {
                        System.Diagnostics.Debug.WriteLine($"[APPROVE] API hatası: {apiEx.Message}");
                        System.Diagnostics.Debug.WriteLine($"[APPROVE] API hatası stack trace: {apiEx.StackTrace}");
                        throw;
                    }
                    
                    // Kısa bir bekleme (veritabanı güncellemesinin tamamlanması için)
                    await Task.Delay(500);
                    
                    // Güncel durumu kontrol et
                    var updatedAppointment = await AppointmentService.GetAppointmentByIdAsync(appointment.Id);
                    if (updatedAppointment != null)
                    {
                        System.Diagnostics.Debug.WriteLine($"[APPROVE] Güncel durum kontrolü - Randevu ID: {updatedAppointment.Id}, Durum: {updatedAppointment.Status}");
                        if (updatedAppointment.Status == AppointmentStatus.Approved)
                        {
                            Snackbar.Add("Randevu başarıyla onaylandı!", Severity.Success);
                        }
                        else
                        {
                            Snackbar.Add($"Randevu onaylandı ancak durum güncellenemedi. Mevcut durum: {updatedAppointment.Status}", Severity.Warning);
                        }
                    }
                    else
                    {
                        Snackbar.Add("Randevu onaylandı ancak güncel durum alınamadı.", Severity.Warning);
                    }
                    
                    // Eğer filtre Pending ise, onaylanan randevu listede görünmeyeceği için filtreyi "Tümü" yap
                    if (Filter.Status == AppointmentStatus.Pending)
                    {
                        Filter.Status = null;
                    }
                    
                    // Listeyi yenile - güncel verileri almak için
                    await LoadAppointments();
                }
                catch (HttpRequestException ex)
                {
                    System.Diagnostics.Debug.WriteLine($"[APPROVE] HttpRequestException: {ex.Message}");
                    Snackbar.Add($"API hatası: {ex.Message}", Severity.Error);
                    await LoadAppointments();
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"[APPROVE] Exception: {ex.Message}, StackTrace: {ex.StackTrace}");
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                    await LoadAppointments();
                }
                finally
                {
                    IsLoading = false;
                    StateHasChanged();
                }
            }
            else
            {
                System.Diagnostics.Debug.WriteLine("[APPROVE] Dialog result kontrolü başarısız - API çağrısı yapılmadı");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Dialog hatası: {ex.Message}", Severity.Error);
        }
    }

    private async Task RejectAppointment(AppointmentDto appointment)
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["Appointment"] = appointment
            };

            var options = new DialogOptions() 
            { 
                CloseButton = true, 
                MaxWidth = MaxWidth.Medium,
                FullWidth = true
            };

            var dialog = await DialogService.ShowAsync<RejectDialog>("Randevu Reddet", parameters, options);
            
            // Console log ekle
            await JSRuntime.InvokeVoidAsync("console.log", "[REJECT] Dialog açıldı, result bekleniyor...");
            
            DialogResult? result = null;
            string? comment = null;
            
            try
            {
                result = await dialog.Result;
                await JSRuntime.InvokeVoidAsync("console.log", $"[REJECT] Dialog result alındı - Canceled: {result?.Canceled}, Data: {result?.Data}, Data Type: {result?.Data?.GetType()?.Name}");
                System.Diagnostics.Debug.WriteLine($"[REJECT] Dialog result alındı - Canceled: {result?.Canceled}, Data: {result?.Data}, Data Type: {result?.Data?.GetType()?.Name}");
                
                // Result kontrolü
                if (result != null && !result.Canceled && result.Data is string commentData)
                {
                    comment = commentData;
                }
            }
            catch (OperationCanceledException)
            {
                // Dialog iptal edildi, sessizce çık
                await JSRuntime.InvokeVoidAsync("console.log", "[REJECT] Dialog iptal edildi (OperationCanceledException)");
                System.Diagnostics.Debug.WriteLine("[REJECT] Dialog iptal edildi (OperationCanceledException)");
                return;
            }
            catch (Exception ex)
            {
                await JSRuntime.InvokeVoidAsync("console.log", $"[REJECT] Dialog exception: {ex.Message}");
                System.Diagnostics.Debug.WriteLine($"[REJECT] Dialog exception: {ex.Message}");
                Snackbar.Add($"Dialog hatası: {ex.Message}", Severity.Error);
                return;
            }

            await JSRuntime.InvokeVoidAsync("console.log", $"[REJECT] Dialog result - Comment: {comment}, IsNullOrWhiteSpace: {string.IsNullOrWhiteSpace(comment)}");

            if (!string.IsNullOrWhiteSpace(comment))
            {
                await JSRuntime.InvokeVoidAsync("console.log", $"[REJECT] Dialog onaylandı, API çağrısı yapılıyor... Comment: {comment}");
                System.Diagnostics.Debug.WriteLine($"[REJECT] Dialog onaylandı, API çağrısı yapılıyor... Comment: {comment}");
                IsLoading = true;
                StateHasChanged();
                
                try
                {
                    var adminName = AuthState.CurrentUser?.FullName ?? AuthState.CurrentUser?.Username ?? "Admin";
                    System.Diagnostics.Debug.WriteLine($"[REJECT] Admin name: {adminName}, Appointment ID: {appointment.Id}, Comment: {comment}");
                    
                    // API çağrısını yap
                    try
                    {
                        System.Diagnostics.Debug.WriteLine($"[REJECT] API çağrısı başlatılıyor...");
                        await AppointmentService.RejectAppointmentAsync(appointment.Id, adminName, comment);
                        System.Diagnostics.Debug.WriteLine($"[REJECT] API çağrısı başarılı - Randevu ID: {appointment.Id}");
                    }
                    catch (Exception apiEx)
                    {
                        System.Diagnostics.Debug.WriteLine($"[REJECT] API hatası: {apiEx.Message}");
                        System.Diagnostics.Debug.WriteLine($"[REJECT] API hatası stack trace: {apiEx.StackTrace}");
                        throw;
                    }
                    
                    // Kısa bir bekleme (veritabanı güncellemesinin tamamlanması için)
                    await Task.Delay(500);
                    
                    // Güncel durumu kontrol et
                    var updatedAppointment = await AppointmentService.GetAppointmentByIdAsync(appointment.Id);
                    if (updatedAppointment != null)
                    {
                        System.Diagnostics.Debug.WriteLine($"[REJECT] Güncel durum kontrolü - Randevu ID: {updatedAppointment.Id}, Durum: {updatedAppointment.Status}");
                        if (updatedAppointment.Status == AppointmentStatus.Rejected)
                        {
                            Snackbar.Add("Randevu başarıyla reddedildi!", Severity.Success);
                        }
                        else
                        {
                            Snackbar.Add($"Randevu reddedildi ancak durum güncellenemedi. Mevcut durum: {updatedAppointment.Status}", Severity.Warning);
                        }
                    }
                    else
                    {
                        Snackbar.Add("Randevu reddedildi ancak güncel durum alınamadı.", Severity.Warning);
                    }
                    
                    // Eğer filtre Pending ise, reddedilen randevu listede görünmeyeceği için filtreyi "Tümü" yap
                    if (Filter.Status == AppointmentStatus.Pending)
                    {
                        Filter.Status = null;
                    }
                    
                    // Listeyi yenile - güncel verileri almak için
                    await LoadAppointments();
                }
                catch (HttpRequestException ex)
                {
                    System.Diagnostics.Debug.WriteLine($"[REJECT] HttpRequestException: {ex.Message}");
                    Snackbar.Add($"API hatası: {ex.Message}", Severity.Error);
                    await LoadAppointments();
                }
                catch (Exception ex)
                {
                    System.Diagnostics.Debug.WriteLine($"[REJECT] Exception: {ex.Message}, StackTrace: {ex.StackTrace}");
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                    await LoadAppointments();
                }
                finally
                {
                    IsLoading = false;
                    StateHasChanged();
                }
            }
            else
            {
                System.Diagnostics.Debug.WriteLine($"[REJECT] Dialog result kontrolü başarısız - result null: {result == null}, Canceled: {result?.Canceled}, Data is string: {result?.Data is string}, Comment empty: {result?.Data is string comment2 && string.IsNullOrWhiteSpace(comment2)}");
            }
        }
        catch (Exception ex)
        {
            System.Diagnostics.Debug.WriteLine($"[REJECT] Outer exception: {ex.Message}, StackTrace: {ex.StackTrace}");
            Snackbar.Add($"Dialog hatası: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowDetails(AppointmentDto appointment)
    {
        // Önce güncel randevu bilgilerini yükle
        var currentAppointment = await AppointmentService.GetAppointmentByIdAsync(appointment.Id);
        if (currentAppointment == null)
        {
            currentAppointment = appointment;
        }

        var parameters = new DialogParameters
        {
            ["Appointment"] = currentAppointment
        };

        var options = new DialogOptions() 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };

        var dialog = await DialogService.ShowAsync<AppointmentDetailDialog>("Randevu Detayları", parameters, options);
        var result = await dialog.Result;
        
        // Dialog kapandıktan sonra listeyi yenile (durum değişiklikleri için)
        await LoadAppointments();
    }

}
