@page "/admin-appointments"
@using AppointmentSystem.Application.DTOs
@using AppointmentSystem.Application.Services
@using AppointmentSystem.Domain.Entities
@using AppointmentSystem.Web.Services
@using MudBlazor
@using MudBlazor.Services
@inject IAppointmentService AppointmentService
@inject IBranchService BranchService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthStateService AuthState
@inject NavigationManager Navigation

<PageTitle>Yönetici Paneli</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">

    <MudPaper Elevation="2" Class="pa-4 rounded-lg">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <MudText Typo="Typo.h5" GutterBottom="false">Yönetici Paneli</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Bekleyen randevu taleplerini onaylayın veya reddedin</MudText>
            </div>
            <MudChip T="string" Color="Color.Warning" Size="Size.Medium" Variant="Variant.Filled">
                @PagedResult.TotalCount Bekleyen Talep
            </MudChip>
        </div>

        <!-- FILTERS -->
        <MudPaper Elevation="0" Class="pa-3 mb-4" Style="background-color: #f5f5f5;">
            <MudGrid Spacing="3">
                <MudItem xs="12" md="3">
                    <MudSelect T="int?" 
                               Value="@Filter.BranchId"
                               ValueChanged="@(async (int? value) => { Filter.BranchId = value; await ApplyFilters(); })"
                               Label="Şube" 
                               Variant="Variant.Outlined"
                               Clearable="true"
                               FullWidth="true">
                        <MudSelectItem T="int?" Value="@((int?)null)">Tümü</MudSelectItem>
                        @foreach (var branch in Branches)
                        {
                            <MudSelectItem T="int?" Value="@branch.Id">@branch.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Date="@Filter.StartDate"
                                   DateChanged="@(async (DateTime? value) => { Filter.StartDate = value; await ApplyFilters(); })"
                                   Label="Başlangıç Tarihi" 
                                   Variant="Variant.Outlined" 
                                   Clearable="true"/>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudDatePicker Date="@Filter.EndDate"
                                   DateChanged="@(async (DateTime? value) => { Filter.EndDate = value; await ApplyFilters(); })"
                                   Label="Bitiş Tarihi" 
                                   Variant="Variant.Outlined" 
                                   Clearable="true"/>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudTextField Value="@Filter.SearchText"
                                  ValueChanged="@((string value) => { Filter.SearchText = value; })"
                                  Label="Ara (Başlık/Kullanıcı)" 
                                  Variant="Variant.Outlined"
                                  Adornment="Adornment.Start" 
                                  AdornmentIcon="@Icons.Material.Filled.Search" 
                                  Immediate="true"
                                  OnKeyDown="@(async (KeyboardEventArgs e) => { if (e.Key == "Enter") await ApplyFilters(); })"
                                  FullWidth="true"/>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudSelect T="string" 
                               Value="@Filter.SortBy"
                               ValueChanged="@(async (string value) => { Filter.SortBy = value; await ApplyFilters(); })"
                               Label="Sırala" 
                               Variant="Variant.Outlined"
                               Clearable="true"
                               FullWidth="true">
                        <MudSelectItem T="string" Value="@("Date")">Tarihe Göre</MudSelectItem>
                        <MudSelectItem T="string" Value="@("RequestedBy")">Kullanıcıya Göre</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="3">
                    <MudSelect T="bool?" 
                               Value="@Filter.SortDescending"
                               ValueChanged="@(async (bool? value) => { Filter.SortDescending = value; await ApplyFilters(); })"
                               Label="Sıralama Yönü" 
                               Variant="Variant.Outlined"
                               FullWidth="true">
                        <MudSelectItem Value="@((bool?)false)">Artan</MudSelectItem>
                        <MudSelectItem Value="@((bool?)true)">Azalan</MudSelectItem>
                    </MudSelect>
                </MudItem>
                <MudItem xs="12" md="3" class="d-flex align-items-end">
                    <MudButton Color="Color.Primary" 
                               OnClick="ApplyFilters" 
                               Variant="Variant.Filled"
                               StartIcon="@Icons.Material.Filled.FilterList"
                               Class="me-2">
                        Filtrele
                    </MudButton>
                    <MudButton Color="Color.Default" 
                               OnClick="ClearFilters"
                               Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.Clear">
                        Temizle
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudPaper>

        <!-- TABLE -->
        <MudTable Items="@PagedResult.Items" 
                  Hover="true" 
                  Bordered="true" 
                  Striped="true" 
                  Dense="false" 
                  Loading="@IsLoading"
                  Elevation="1">
            <HeaderContent>
                <MudTh>Talep No</MudTh>
                <MudTh>Başlık</MudTh>
                <MudTh>Talep Eden</MudTh>
                <MudTh>Tarih</MudTh>
                <MudTh>Saat</MudTh>
                <MudTh>Şube</MudTh>
                <MudTh>Açıklama</MudTh>
                <MudTh>İşlemler</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd><strong>#@context.Id</strong></MudTd>
                <MudTd>@context.Title</MudTd>
                <MudTd>
                    <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Text">
                        @context.RequestedBy
                    </MudChip>
                </MudTd>
                <MudTd>@context.Date.ToString("dd.MM.yyyy")</MudTd>
                <MudTd>@context.StartTime.ToString(@"hh\:mm") - @context.EndTime.ToString(@"hh\:mm")</MudTd>
                <MudTd>@context.BranchName</MudTd>
                <MudTd>
                    <MudText Typo="Typo.body2" 
                             Style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;"
                             title="@context.Description">
                        @(string.IsNullOrEmpty(context.Description) ? "-" : context.Description)
                    </MudText>
                </MudTd>
                <MudTd>
                    <div class="d-flex align-items-center">
                        <MudButton Color="Color.Success" 
                                   Size="Size.Small" 
                                   Variant="Variant.Filled"
                                   StartIcon="@Icons.Material.Filled.Check" 
                                   OnClick="@(async () => await ApproveAppointment(context))" 
                                   Disabled="@IsLoading"
                                   Class="me-2">
                            Onayla
                        </MudButton>
                        <MudButton Color="Color.Error" 
                                   Size="Size.Small" 
                                   Variant="Variant.Filled"
                                   StartIcon="@Icons.Material.Filled.Close" 
                                   OnClick="@(async () => await RejectAppointment(context))"
                                   Disabled="@IsLoading">
                            Reddet
                        </MudButton>
                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                       Color="Color.Primary" 
                                       Size="Size.Small" 
                                       OnClick="@(async () => await ShowDetails(context))" 
                                       Disabled="@IsLoading"
                                       Class="ms-2"
                                       title="Detayları Görüntüle"/>
                    </div>
                </MudTd>
            </RowTemplate>
            <PagerContent>
                <MudTablePager t="AppointmentDto" 
                               PageSizeOptions="new int[] { 10, 25, 50 }"
                               InfoFormat="{first_item}-{last_item} / {all_items}"
                               pageSizeChanged="OnPageSizeChanged"
                               pageChanged="OnPageChanged"
                               pageSize="@Filter.PageSize"
                               currentPage="@Filter.PageNumber"
                               totalItems="@PagedResult.TotalCount" />
            </PagerContent>
        </MudTable>

        @if (!PagedResult.Items.Any() && !IsLoading)
        {
            <MudAlert Severity="Severity.Success" Class="mt-4">
                Tüm randevu talepleri işlendi. Bekleyen talep bulunmamaktadır.
            </MudAlert>
        }

    </MudPaper>

</MudContainer>

@code {
    private AppointmentFilterDto Filter = new() { PageSize = 10 };
    private PagedResult<AppointmentDto> PagedResult = new();
    private bool IsLoading = false;
    private List<BranchDto> Branches = new();

    protected override async Task OnInitializedAsync()
    {
        // Initialization'ı bekle
        await AuthState.WaitForInitializationAsync();
        
        // Admin kontrolü
        if (!AuthState.IsAuthenticated || !AuthState.IsAdmin)
        {
            Snackbar.Add("Bu sayfaya erişim yetkiniz yok!", Severity.Error);
            if (AuthState.IsAuthenticated)
            {
                Navigation.NavigateTo("/appointments");
            }
            else
            {
                Navigation.NavigateTo("/login");
            }
            return;
        }

        try
        {
            Branches = await BranchService.GetAllBranchesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Şubeler yüklenirken hata oluştu: {ex.Message}", Severity.Warning);
        }
        await LoadAppointments();
    }

    private async Task LoadAppointments()
    {
        IsLoading = true;
        StateHasChanged();
        try
        {
            PagedResult = await AppointmentService.GetPendingAppointmentsAsync(Filter);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task ApplyFilters()
    {
        Filter.PageNumber = 1;
        await LoadAppointments();
    }

    private async Task ClearFilters()
    {
        Filter = new AppointmentFilterDto { PageSize = 10 };
        await LoadAppointments();
    }

    private async Task OnPageChanged(int page)
    {
        Filter.PageNumber = page;
        await LoadAppointments();
    }

    private async Task OnPageSizeChanged(int pageSize)
    {
        Filter.PageSize = pageSize;
        Filter.PageNumber = 1;
        await LoadAppointments();
    }

    private async Task ApproveAppointment(AppointmentDto appointment)
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["Message"] = $"'{appointment.Title}' başlıklı randevuyu onaylamak istediğinizden emin misiniz?",
                ["ConfirmText"] = "Onayla",
                ["CancelText"] = "İptal"
            };

            var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
            var dialog = await DialogService.ShowAsync<ConfirmDialog>("Onay", parameters, options);
            var result = await dialog.Result;

            // Dialog iptal edilmediyse ve result varsa onayla
            if (result != null && !result.Canceled)
            {
                IsLoading = true;
                StateHasChanged();
                
                try
                {
                    var adminName = AuthState.CurrentUser?.FullName ?? AuthState.CurrentUser?.Username ?? "Admin";
                    await AppointmentService.ApproveAppointmentAsync(appointment.Id, adminName);
                    Snackbar.Add("Randevu onaylandı!", Severity.Success);
                    
                    // Listeyi yenile
                    await LoadAppointments();
                }
                catch (HttpRequestException ex)
                {
                    Snackbar.Add($"API hatası: {ex.Message}", Severity.Error);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                }
                finally
                {
                    IsLoading = false;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Dialog hatası: {ex.Message}", Severity.Error);
        }
    }

    private async Task RejectAppointment(AppointmentDto appointment)
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["Appointment"] = appointment
            };

            var options = new DialogOptions() 
            { 
                CloseButton = true, 
                MaxWidth = MaxWidth.Medium,
                FullWidth = true
            };

            var dialog = await DialogService.ShowAsync<RejectDialog>("Randevu Reddet", parameters, options);
            var result = await dialog.Result;

            if (result != null && !result.Canceled && result.Data is string comment && !string.IsNullOrWhiteSpace(comment))
            {
                IsLoading = true;
                StateHasChanged();
                
                try
                {
                    var adminName = AuthState.CurrentUser?.FullName ?? AuthState.CurrentUser?.Username ?? "Admin";
                    await AppointmentService.RejectAppointmentAsync(appointment.Id, adminName, comment);
                    Snackbar.Add("Randevu reddedildi!", Severity.Success);
                    
                    // Listeyi yenile
                    await LoadAppointments();
                }
                catch (HttpRequestException ex)
                {
                    Snackbar.Add($"API hatası: {ex.Message}", Severity.Error);
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                }
                finally
                {
                    IsLoading = false;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Dialog hatası: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowDetails(AppointmentDto appointment)
    {
        // Önce güncel randevu bilgilerini yükle
        var currentAppointment = await AppointmentService.GetAppointmentByIdAsync(appointment.Id);
        if (currentAppointment == null)
        {
            currentAppointment = appointment;
        }

        var parameters = new DialogParameters
        {
            ["Appointment"] = currentAppointment
        };

        var options = new DialogOptions() 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };

        await DialogService.ShowAsync<AppointmentDetailDialog>("Randevu Detayları", parameters, options);
    }
}
