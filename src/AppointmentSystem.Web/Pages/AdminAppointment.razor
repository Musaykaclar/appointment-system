@page "/admin-appointments"
@using AppointmentSystem.Application.DTOs
@using AppointmentSystem.Application.Services
@using AppointmentSystem.Domain.Entities
@using AppointmentSystem.Web.Services
@using AppointmentSystem.Web.Helpers
@using MudBlazor
@inject IAppointmentService AppointmentService
@inject IBranchService BranchService
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthStateService AuthState
@inject NavigationManager Navigation

<PageTitle>Yönetici Paneli</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge">
    <MudPaper Elevation="2" Class="pa-4 rounded-lg">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <MudText Typo="Typo.h5" GutterBottom="false">Yönetici Paneli</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Randevu taleplerini görüntüleyin, onaylayın veya reddedin</MudText>
            </div>
            <MudChip T="string" Color="@AppointmentStatusHelper.GetStatusChipColor(Filter.Status)" Size="Size.Medium" Variant="Variant.Filled">
                @PagedResult.TotalCount @AppointmentStatusHelper.GetStatusChipText(Filter.Status)
            </MudChip>
        </div>

        <AppointmentFilterPanel Filter="@Filter" 
                                Branches="@Branches" 
                                UseStringStatusFilter="true"
                                OnFilterChanged="ApplyFilters"
                                OnClearFilters="ClearFilters" />

        <AppointmentTable Appointments="@PagedResult.Items"
                          IsLoading="@IsLoading"
                          PageSize="@(Filter.PageSize ?? 10)"
                          CurrentPage="@(Filter.PageNumber ?? 1)"
                          TotalCount="@PagedResult.TotalCount"
                          OnPageChanged="@(async (int page) => await OnPageChanged(page))"
                          OnPageSizeChanged="@(async (int pageSize) => await OnPageSizeChanged(pageSize))"
                          ShowRequestedBy="true"
                          ShowRequestedByAsChip="true"
                          ShowDescription="true"
                          ShowDateBeforeBranch="true"
                          ShowApproveRejectButtons="true"
                          OnApprove="@(async (appointment) => await ApproveAppointment(appointment))"
                          OnReject="@(async (appointment) => await RejectAppointment(appointment))"
                          OnShowDetails="@(async (appointment) => await ShowDetails(appointment))" />

        @if (!PagedResult.Items.Any() && !IsLoading)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">
                @if (Filter.Status == AppointmentStatus.Pending)
                {
                    <text>Tüm randevu talepleri işlendi. Bekleyen talep bulunmamaktadır.</text>
                }
                else if (Filter.Status.HasValue)
                {
                    <text>Seçilen duruma göre randevu bulunamadı.</text>
                }
                else
                {
                    <text>Randevu bulunamadı.</text>
                }
            </MudAlert>
        }

    </MudPaper>

</MudContainer>

@code {
    private AppointmentFilterDto Filter = new() { PageSize = 10, Status = AppointmentStatus.Pending };
    private PagedResult<AppointmentDto> PagedResult = new();
    private bool IsLoading = false;
    private List<BranchDto> Branches = new();

    protected override async Task OnInitializedAsync()
    {
        // Initialization'ı bekle
        await AuthState.WaitForInitializationAsync();
        
        // Admin kontrolü
        if (!AuthState.IsAuthenticated || !AuthState.IsAdmin)
        {
            Snackbar.Add("Bu sayfaya erişim yetkiniz yok!", Severity.Error);
            if (AuthState.IsAuthenticated)
            {
                Navigation.NavigateTo("/appointments");
            }
            else
            {
                Navigation.NavigateTo("/login");
            }
            return;
        }

        try
        {
            Branches = await BranchService.GetAllBranchesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Şubeler yüklenirken hata oluştu: {ex.Message}", Severity.Warning);
        }
        await LoadAppointments();
    }

    private async Task LoadAppointments()
    {
        IsLoading = true;
        StateHasChanged();
        try
        {
            // Eğer durum filtresi yoksa veya Pending ise, tüm randevuları göster
            // Aksi halde seçilen duruma göre filtrele
            if (Filter.Status == null || Filter.Status == AppointmentStatus.Pending)
            {
                // Pending durumu için özel metod kullan (varsayılan davranış)
                if (Filter.Status == AppointmentStatus.Pending)
                {
                    PagedResult = await AppointmentService.GetPendingAppointmentsAsync(Filter);
                }
                else
                {
                    // Tümü seçildiğinde tüm randevuları göster
                    PagedResult = await AppointmentService.GetAppointmentsAsync(Filter);
                }
            }
            else
            {
                // Approved veya Rejected durumu için normal filtreleme kullan
                PagedResult = await AppointmentService.GetAppointmentsAsync(Filter);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
            StateHasChanged();
        }
    }

    private async Task ApplyFilters()
    {
        Filter.PageNumber = 1;
        await LoadAppointments();
    }

    private async Task ClearFilters()
    {
        Filter = new AppointmentFilterDto { PageSize = 10 };
        await LoadAppointments();
    }

    private async Task OnPageChanged(int page)
    {
        Filter.PageNumber = page;
        await LoadAppointments();
    }

    private async Task OnPageSizeChanged(int pageSize)
    {
        Filter.PageSize = pageSize;
        Filter.PageNumber = 1;
        await LoadAppointments();
    }

    private async Task ApproveAppointment(AppointmentDto appointment)
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["Message"] = $"'{appointment.Title}' başlıklı randevuyu onaylamak istediğinizden emin misiniz?",
                ["ConfirmText"] = "Onayla",
                ["CancelText"] = "İptal"
            };

            var options = new DialogOptions() { CloseButton = true, MaxWidth = MaxWidth.Small };
            var dialog = await DialogService.ShowAsync<ConfirmDialog>("Onay", parameters, options);
            var result = await dialog.Result;

            // Dialog iptal edilmediyse ve result varsa onayla
            if (result != null && !result.Canceled)
            {
                IsLoading = true;
                StateHasChanged();
                
                try
                {
                    var adminName = AuthState.CurrentUser?.FullName ?? AuthState.CurrentUser?.Username ?? "Admin";
                    
                    // Mevcut durumu kontrol et
                    var currentAppointment = await AppointmentService.GetAppointmentByIdAsync(appointment.Id);
                    if (currentAppointment == null)
                    {
                        Snackbar.Add("Randevu bulunamadı!", Severity.Error);
                        await LoadAppointments();
                        return;
                    }

                    // API çağrısını yap
                    await AppointmentService.ApproveAppointmentAsync(appointment.Id, adminName);
                    
                    // Başarı mesajı
                    Snackbar.Add("Randevu başarıyla onaylandı ve veritabanında güncellendi!", Severity.Success);
                    
                    // Kısa bir gecikme ekle (veritabanı güncellemesinin tamamlanması için)
                    await Task.Delay(200);
                    
                    // Listeyi yenile - güncel verileri almak için
                    await LoadAppointments();
                    
                    // State'i güncelle
                    StateHasChanged();
                }
                catch (HttpRequestException ex)
                {
                    Snackbar.Add($"API hatası: {ex.Message}", Severity.Error);
                    // Hata durumunda da listeyi yenile
                    await LoadAppointments();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                    // Hata durumunda da listeyi yenile
                    await LoadAppointments();
                }
                finally
                {
                    IsLoading = false;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Dialog hatası: {ex.Message}", Severity.Error);
        }
    }

    private async Task RejectAppointment(AppointmentDto appointment)
    {
        try
        {
            var parameters = new DialogParameters
            {
                ["Appointment"] = appointment
            };

            var options = new DialogOptions() 
            { 
                CloseButton = true, 
                MaxWidth = MaxWidth.Medium,
                FullWidth = true
            };

            var dialog = await DialogService.ShowAsync<RejectDialog>("Randevu Reddet", parameters, options);
            var result = await dialog.Result;

            if (result != null && !result.Canceled && result.Data is string comment && !string.IsNullOrWhiteSpace(comment))
            {
                IsLoading = true;
                StateHasChanged();
                
                try
                {
                    var adminName = AuthState.CurrentUser?.FullName ?? AuthState.CurrentUser?.Username ?? "Admin";
                    
                    // API çağrısını yap
                    await AppointmentService.RejectAppointmentAsync(appointment.Id, adminName, comment);
                    
                    // Başarı mesajı
                    Snackbar.Add("Randevu başarıyla reddedildi ve veritabanında güncellendi!", Severity.Success);
                    
                    // Kısa bir gecikme ekle (veritabanı güncellemesinin tamamlanması için)
                    await Task.Delay(100);
                    
                    // Listeyi yenile - güncel verileri almak için
                    await LoadAppointments();
                    
                    // State'i güncelle
                    StateHasChanged();
                }
                catch (HttpRequestException ex)
                {
                    Snackbar.Add($"API hatası: {ex.Message}", Severity.Error);
                    // Hata durumunda da listeyi yenile
                    await LoadAppointments();
                }
                catch (Exception ex)
                {
                    Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
                    // Hata durumunda da listeyi yenile
                    await LoadAppointments();
                }
                finally
                {
                    IsLoading = false;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Dialog hatası: {ex.Message}", Severity.Error);
        }
    }

    private async Task ShowDetails(AppointmentDto appointment)
    {
        // Önce güncel randevu bilgilerini yükle
        var currentAppointment = await AppointmentService.GetAppointmentByIdAsync(appointment.Id);
        if (currentAppointment == null)
        {
            currentAppointment = appointment;
        }

        var parameters = new DialogParameters
        {
            ["Appointment"] = currentAppointment
        };

        var options = new DialogOptions() 
        { 
            MaxWidth = MaxWidth.Medium, 
            FullWidth = true,
            CloseButton = true
        };

        await DialogService.ShowAsync<AppointmentDetailDialog>("Randevu Detayları", parameters, options);
    }

}
