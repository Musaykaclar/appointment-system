@page "/appointment-form"
@using AppointmentSystem.Application.DTOs
@using AppointmentSystem.Application.Services
@using AppointmentSystem.Web.Services
@using MudBlazor
@using MudBlazor.Services
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http
@inject IAppointmentService AppointmentService
@inject IBranchService BranchService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager
@inject AuthStateService AuthState

<PageTitle>Randevu Talep Formu</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudPaper Elevation="2" Class="pa-6 rounded-lg">
        <div class="mb-4">
            <MudText Typo="Typo.h5" GutterBottom="false">Randevu Talep Formu</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Lütfen randevu bilgilerinizi doldurunuz</MudText>
        </div>

        <EditForm Model="@AppointmentModel" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />

            <MudGrid Spacing="3">
                //Şube Seçimi
                <MudItem xs="12">
                    @if (IsLoadingBranches)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-2" />
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Şubeler yükleniyor...</MudText>
                    }
                    else if (Branches == null || !Branches.Any())
                    {
                        <MudAlert Severity="Severity.Warning">
                            Şube bulunamadı. Lütfen API'nin çalıştığından emin olun.
                        </MudAlert>
                    }
                    else
                    {
                        <MudSelect T="int?" 
                                   Value="@selectedBranchIdNullable"
                                   ValueChanged="@OnBranchChanged"
                                   Label="Şube*" 
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Şube seçimi zorunludur"
                                   FullWidth="true"
                                   Clearable="false"
                                   HelperText="Lütfen bir şube seçiniz">
                            @if (Branches != null && Branches.Any())
                            {
                                @foreach (var branch in Branches)
                                {
                                    <MudSelectItem T="int?" @key="@branch.Id" Value="@branch.Id">@branch.Name - @branch.Location</MudSelectItem>
                                }
                            }
                        </MudSelect>
                    }
                </MudItem>

                //Açıklama
                <MudItem xs="12">
                    <MudTextField @bind-Value="AppointmentModel.Description" 
                                  Label="Açıklama" 
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Lines="3"
                                  Counter="250"
                                  MaxLength="250"
                                  FullWidth="true" />
                </MudItem>

                //Talep Tarihi
                <MudItem xs="12" md="6">
                    <MudDatePicker @bind-Date="selectedDate" 
                                  Label="Talep Tarihi*" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  MinDate="@DateTime.Today"
                                  MaxDate="@DateTime.Today.AddMonths(6)"
                                  RequiredError="Talep tarihi zorunludur"
                                  HelperText="Bugünden itibaren 6 ay içinde bir tarih seçiniz" />
                    @if (selectedDate.HasValue && selectedDate.Value < DateTime.Today)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Error">Talep tarihi bugünden önce olamaz</MudText>
                    }
                </MudItem>

                //Başlangıç Saati
                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="startTimeString" 
                                  Label="Başlangıç Saati*" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  InputType="InputType.Time"
                                  OnBlur="OnStartTimeChanged"
                                  FullWidth="true" />
                    <ValidationMessage For="@(() => AppointmentModel.StartTime)" />
                </MudItem>

                //Bitiş Saati
                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="endTimeString" 
                                  Label="Bitiş Saati*" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  InputType="InputType.Time"
                                  OnBlur="OnEndTimeChanged"
                                  FullWidth="true" />
                    <ValidationMessage For="@(() => AppointmentModel.EndTime)" />
                </MudItem>

                //Lokasyon
                @if (!string.IsNullOrEmpty(Location))
                {
                    <MudItem xs="12">
                        <MudTextField Value="@Location" 
                                      Label="Lokasyon" 
                                      Variant="Variant.Outlined"
                                      ReadOnly="true"
                                      Disabled="true"
                                      FullWidth="true" />
                    </MudItem>
                }

                //Validation Hatası
                @if (!string.IsNullOrEmpty(validationError))
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Error" Class="mt-2">@validationError</MudAlert>
                    </MudItem>
                }

                //Gönder Butonu
                <MudItem xs="12" Class="mt-4">
                    <div class="d-flex gap-2">
                        <MudButton ButtonType="ButtonType.Submit" 
                                   Color="Color.Primary" 
                                   Variant="Variant.Filled"
                                   Size="Size.Large"
                                   FullWidth="true"
                                   Disabled="@IsSubmitting"
                                   StartIcon="@Icons.Material.Filled.Send">
                            @if (IsSubmitting)
                            {
                                <MudProgressCircular Class="me-2" Size="Size.Small" Indeterminate="true" />
                            }
                            Gönder
                        </MudButton>
                        <MudButton Color="Color.Default" 
                                   Variant="Variant.Outlined"
                                   Size="Size.Large"
                                   Href="/appointments"
                                   StartIcon="@Icons.Material.Filled.Cancel">
                            İptal
                        </MudButton>
                    </div>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudPaper>
</MudContainer>


@code {
    private AppointmentDto AppointmentModel = new();
    private List<BranchDto> Branches = new();
    private bool IsLoadingBranches = true;
    
    private DateTime? selectedDate
    {
        get => AppointmentModel.Date == DateTime.MinValue ? null : AppointmentModel.Date;
        set
        {
            if (value.HasValue)
            {
                AppointmentModel.Date = value.Value.Date; // Sadece tarih kısmı alınsn
            }
            else
            {
                AppointmentModel.Date = DateTime.MinValue;
            }
            ValidateForm();
            StateHasChanged();
        }
    }
    
    private string Location { get; set; } = string.Empty;
    private string validationError = string.Empty;
    private bool IsSubmitting = false;
    private string startTimeString = string.Empty;
    private string endTimeString = string.Empty;
    
    private int? selectedBranchIdNullable
    {
        get => AppointmentModel.BranchId > 0 ? AppointmentModel.BranchId : null;
        set
        {
            if (value.HasValue)
            {
                AppointmentModel.BranchId = value.Value;
            }
            else
            {
                AppointmentModel.BranchId = 0;
            }
            UpdateLocation();
            ValidateForm();
            StateHasChanged();
        }
    }
    
    private int selectedBranchId => AppointmentModel.BranchId;

    private async Task OnBranchChanged(int? value)
    {
        selectedBranchIdNullable = value;
        await Task.CompletedTask;
    }
    
    private void UpdateLocation()
    {
        if (AppointmentModel.BranchId > 0)
        {
            var branch = Branches.FirstOrDefault(b => b.Id == AppointmentModel.BranchId);
            Location = branch?.Location ?? string.Empty;
        }
        else
        {
            Location = string.Empty;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Initialization'ı bekle
        await AuthState.WaitForInitializationAsync();
        
        // Login kontrolü
        if (!AuthState.IsAuthenticated)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        // Yönetici bu sayfaya erişemez
        if (AuthState.IsAdmin)
        {
            Snackbar.Add("Yöneticiler bu sayfaya erişemez!", Severity.Warning);
            NavigationManager.NavigateTo("/admin-appointments");
            return;
        }

        await LoadBranches();
    }

    //Şubeleri yüklemek için çalışır
    private async Task LoadBranches()
    {
        IsLoadingBranches = true;
        StateHasChanged();
        
        try
        {
            var loadedBranches = await BranchService.GetAllBranchesAsync();
            Branches = loadedBranches ?? new List<BranchDto>();
            
            if (Branches == null || !Branches.Any())
            {
                Snackbar.Add("Şube bulunamadı. Lütfen API'nin çalıştığından emin olun.", Severity.Warning);
                Console.WriteLine("Şube listesi boş döndü.");
            }
            else
            {
                Console.WriteLine($"Şubeler başarıyla yüklendi. Toplam: {Branches.Count}");
                foreach (var branch in Branches)
                {
                    Console.WriteLine($"  - {branch.Id}: {branch.Name} ({branch.Location})");
                }
                Snackbar.Add($"{Branches.Count} şube yüklendi", Severity.Success);
            }
        }
        catch (HttpRequestException ex)
        {
            Snackbar.Add($"API'ye bağlanılamadı. Lütfen API'nin çalıştığından emin olun. Hata: {ex.Message}", Severity.Error);
            Console.WriteLine($"HTTP Hatası: {ex}");
            Branches = new List<BranchDto>();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Şubeler yüklenirken hata oluştu: {ex.Message}", Severity.Error);
            Console.WriteLine($"Şube yükleme hatası: {ex}");
            Branches = new List<BranchDto>();
        }
        finally
        {
            IsLoadingBranches = false;
            StateHasChanged();
        }
    }



    //Başlangıç Saati değiştiğinde çalışır
    private void OnStartTimeChanged()
    {
        if (TimeSpan.TryParse(startTimeString, out var time))
        {
            AppointmentModel.StartTime = time;
        }
        ValidateForm();
        StateHasChanged();
    }

    //Bitiş Saati değiştiğinde çalışır
    private void OnEndTimeChanged()
    {
        if (TimeSpan.TryParse(endTimeString, out var time))
        {
            AppointmentModel.EndTime = time;
        }
        ValidateForm();
        StateHasChanged();
    }

    //Form doğrulama için çalışır
    private void ValidateForm()
    {
        validationError = string.Empty;

        if (AppointmentModel.EndTime <= AppointmentModel.StartTime)
        {
            validationError = "Bitiş saati, başlangıç saatinden sonra olmalıdır.";
            return;
        }

        if (AppointmentModel.Date < DateTime.Today)
        {
            validationError = "Talep tarihi bugünden önce olamaz.";
            return;
        }
    }

    //Form gönderildiğinde çalışır
    private async Task HandleValidSubmit()
    {
        validationError = string.Empty;

        // Saat string'lerini TimeSpan'e çevir
        if (!string.IsNullOrWhiteSpace(startTimeString) && TimeSpan.TryParse(startTimeString, out var startTime))
        {
            AppointmentModel.StartTime = startTime;
        }
        else
        {
            Snackbar.Add("Başlangıç saati geçerli bir saat formatında olmalıdır.", Severity.Error);
            return;
        }
        
        if (!string.IsNullOrWhiteSpace(endTimeString) && TimeSpan.TryParse(endTimeString, out var endTime))
        {
            AppointmentModel.EndTime = endTime;
        }
        else
        {
            Snackbar.Add("Bitiş saati geçerli bir saat formatında olmalıdır.", Severity.Error);
            return;
        }

        // Doğrulama kuralları
        if (AppointmentModel.EndTime <= AppointmentModel.StartTime)
        {
            validationError = "Bitiş saati, başlangıç saatinden sonra olmalıdır.";
            Snackbar.Add(validationError, Severity.Error);
            return;
        }

        if (AppointmentModel.Date < DateTime.Today)
        {
            validationError = "Talep tarihi bugünden önce olamaz.";
            Snackbar.Add(validationError, Severity.Error);
            return;
        }

        if (AppointmentModel.BranchId <= 0)
        {
            validationError = "Şube seçimi zorunludur.";
            Snackbar.Add(validationError, Severity.Error);
            return;
        }

        IsSubmitting = true;
        StateHasChanged();
        
        try
        {
            // Başlık oluştur (eğer yoksa)
            if (string.IsNullOrWhiteSpace(AppointmentModel.Title))
            {
                var branch = Branches.FirstOrDefault(b => b.Id == AppointmentModel.BranchId);
                AppointmentModel.Title = $"{branch?.Name ?? "Randevu"} - {AppointmentModel.Date:dd.MM.yyyy}";
            }

            // Talep eden kullanıcı
            if (AuthState.CurrentUser != null)
            {
                AppointmentModel.RequestedBy = AuthState.CurrentUser.FullName;
                AppointmentModel.RequestedById = AuthState.CurrentUser.Id;
            }
            else if (string.IsNullOrWhiteSpace(AppointmentModel.RequestedBy))
            {
                AppointmentModel.RequestedBy = "Kullanıcı";
            }

            // Date'i UTC'ye çevir (PostgreSQL için)
            if (AppointmentModel.Date != DateTime.MinValue)
            {
                AppointmentModel.Date = DateTime.SpecifyKind(AppointmentModel.Date.Date, DateTimeKind.Utc);
            }

            // Şube kontrolü
            if (AppointmentModel.BranchId <= 0)
            {
                Snackbar.Add("Lütfen bir şube seçiniz", Severity.Error);
                IsSubmitting = false;
                StateHasChanged();
                return;
            }

            // Tarih kontrolü
            if (AppointmentModel.Date < DateTime.Today)
            {
                Snackbar.Add("Talep tarihi bugünden önce olamaz", Severity.Error);
                IsSubmitting = false;
                StateHasChanged();
                return;
            }

            Console.WriteLine($"Randevu gönderiliyor: BranchId={AppointmentModel.BranchId}, Date={AppointmentModel.Date}, StartTime={AppointmentModel.StartTime}, EndTime={AppointmentModel.EndTime}");

            await AppointmentService.CreateAppointmentAsync(AppointmentModel);
            
            Snackbar.Add("Randevu talebi başarıyla gönderildi!", Severity.Success);
            
            // Formu temizle
            AppointmentModel = new AppointmentDto();
            selectedBranchIdNullable = null;
            selectedDate = null;
            Location = string.Empty;
            startTimeString = string.Empty;
            endTimeString = string.Empty;
            validationError = string.Empty;
            
            // Listeye yönlendir
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/appointments");
        }
        catch (HttpRequestException ex)
        {
            Snackbar.Add($"API'ye bağlanılamadı: {ex.Message}", Severity.Error);
            Console.WriteLine($"HTTP Hatası: {ex}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Randevu gönderilirken hata oluştu: {ex.Message}", Severity.Error);
            Console.WriteLine($"Randevu gönderme hatası: {ex}");
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }
}
