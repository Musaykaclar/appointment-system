@page "/appointment-form"
@using AppointmentSystem.Application.DTOs
@using AppointmentSystem.Application.Services
@using MudBlazor
@using MudBlazor.Services
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Forms
@using System.Net.Http
@inject IAppointmentService AppointmentService
@inject IBranchService BranchService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Randevu Talep Formu</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudPaper Elevation="2" Class="pa-6 rounded-lg">
        <div class="mb-4">
            <MudText Typo="Typo.h5" GutterBottom="false">Randevu Talep Formu</MudText>
            <MudText Typo="Typo.body2" Color="Color.Secondary">Lütfen randevu bilgilerinizi doldurunuz</MudText>
        </div>

        <EditForm Model="@AppointmentModel" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator />

            <MudGrid Spacing="3">
                <!-- Şube Seçimi -->
                <MudItem xs="12">
                    @if (IsLoadingBranches)
                    {
                        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="mb-2" />
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Şubeler yükleniyor...</MudText>
                    }
                    else
                    {
                        <MudSelect T="int?" 
                                   @bind-Value="selectedBranchIdNullable" 
                                   Label="Şube*" 
                                   Variant="Variant.Outlined"
                                   Required="true"
                                   RequiredError="Şube seçimi zorunludur"
                                   FullWidth="true"
                                   Clearable="false">
                            @if (Branches.Any())
                            {
                                @foreach (var branch in Branches)
                                {
                                    <MudSelectItem Value="@branch.Id">@branch.Name</MudSelectItem>
                                }
                            }
                            else
                            {
                                <MudSelectItem Value="@((int?)null)" Disabled="true">Şube bulunamadı</MudSelectItem>
                            }
                        </MudSelect>
                        @if (selectedBranchId <= 0 && !string.IsNullOrEmpty(validationError))
                        {
                            <MudText Typo="Typo.caption" Color="Color.Error">Şube seçimi zorunludur</MudText>
                        }
                    }
                </MudItem>

                <!-- Açıklama -->
                <MudItem xs="12">
                    <MudTextField @bind-Value="AppointmentModel.Description" 
                                  Label="Açıklama" 
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Lines="3"
                                  Counter="250"
                                  MaxLength="250"
                                  FullWidth="true" />
                </MudItem>

                <!-- Talep Tarihi -->
                <MudItem xs="12" md="6">
                    <MudDatePicker @bind-Date="selectedDate" 
                                  Label="Talep Tarihi*" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  MinDate="@DateTime.Today"
                                  RequiredError="Talep tarihi zorunludur"
                                  FullWidth="true" />
                    <ValidationMessage For="@(() => AppointmentModel.Date)" />
                </MudItem>

                <!-- Başlangıç Saati -->
                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="startTimeString" 
                                  Label="Başlangıç Saati*" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  InputType="InputType.Time"
                                  OnBlur="OnStartTimeChanged"
                                  FullWidth="true" />
                    <ValidationMessage For="@(() => AppointmentModel.StartTime)" />
                </MudItem>

                <!-- Bitiş Saati -->
                <MudItem xs="12" md="3">
                    <MudTextField @bind-Value="endTimeString" 
                                  Label="Bitiş Saati*" 
                                  Variant="Variant.Outlined"
                                  Required="true"
                                  InputType="InputType.Time"
                                  OnBlur="OnEndTimeChanged"
                                  FullWidth="true" />
                    <ValidationMessage For="@(() => AppointmentModel.EndTime)" />
                </MudItem>

                <!-- Lokasyon -->
                @if (!string.IsNullOrEmpty(Location))
                {
                    <MudItem xs="12">
                        <MudTextField Value="@Location" 
                                      Label="Lokasyon" 
                                      Variant="Variant.Outlined"
                                      ReadOnly="true"
                                      Disabled="true"
                                      FullWidth="true" />
                    </MudItem>
                }

                <!-- Validation Hatası -->
                @if (!string.IsNullOrEmpty(validationError))
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Error" Class="mt-2">@validationError</MudAlert>
                    </MudItem>
                }

                <!-- Gönder Butonu -->
                <MudItem xs="12" Class="mt-4">
                    <div class="d-flex gap-2">
                        <MudButton ButtonType="ButtonType.Submit" 
                                   Color="Color.Primary" 
                                   Variant="Variant.Filled"
                                   Size="Size.Large"
                                   FullWidth="true"
                                   Disabled="@IsSubmitting"
                                   StartIcon="@Icons.Material.Filled.Send">
                            @if (IsSubmitting)
                            {
                                <MudProgressCircular Class="me-2" Size="Size.Small" Indeterminate="true" />
                            }
                            Gönder
                        </MudButton>
                        <MudButton Color="Color.Default" 
                                   Variant="Variant.Outlined"
                                   Size="Size.Large"
                                   Href="/appointments"
                                   StartIcon="@Icons.Material.Filled.Cancel">
                            İptal
                        </MudButton>
                    </div>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudPaper>
</MudContainer>


@code {
    private AppointmentDto AppointmentModel = new();
    private List<BranchDto> Branches = new();
    private bool IsLoadingBranches = true;
    
    private DateTime? selectedDate
    {
        get => AppointmentModel.Date == DateTime.MinValue ? null : AppointmentModel.Date;
        set
        {
            if (value.HasValue)
            {
                AppointmentModel.Date = value.Value.Date; // Sadece tarih kısmını al
            }
            else
            {
                AppointmentModel.Date = DateTime.MinValue;
            }
            ValidateForm();
            StateHasChanged();
        }
    }
    
    private string Location { get; set; } = string.Empty;
    private string validationError = string.Empty;
    private bool IsSubmitting = false;
    private string startTimeString = string.Empty;
    private string endTimeString = string.Empty;
    
    private int? selectedBranchIdNullable
    {
        get => AppointmentModel.BranchId > 0 ? AppointmentModel.BranchId : null;
        set
        {
            AppointmentModel.BranchId = value ?? 0;
            UpdateLocation();
            ValidateForm();
            StateHasChanged();
        }
    }
    
    private int selectedBranchId => AppointmentModel.BranchId;
    
    private void UpdateLocation()
    {
        if (AppointmentModel.BranchId > 0)
        {
            var branch = Branches.FirstOrDefault(b => b.Id == AppointmentModel.BranchId);
            Location = branch?.Location ?? string.Empty;
        }
        else
        {
            Location = string.Empty;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        IsLoadingBranches = true;
        StateHasChanged();
        
        try
        {
            Branches = await BranchService.GetAllBranchesAsync();
            if (!Branches.Any())
            {
                Snackbar.Add("Şube bulunamadı. Lütfen API'nin çalıştığından emin olun.", Severity.Warning);
                Console.WriteLine("Şube listesi boş döndü.");
            }
            else
            {
                Console.WriteLine($"Şubeler başarıyla yüklendi. Toplam: {Branches.Count}");
            }
        }
        catch (HttpRequestException ex)
        {
            Snackbar.Add($"API'ye bağlanılamadı. Lütfen API'nin çalıştığından emin olun. Hata: {ex.Message}", Severity.Error);
            Console.WriteLine($"HTTP Hatası: {ex}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Şubeler yüklenirken hata oluştu: {ex.Message}", Severity.Error);
            Console.WriteLine($"Şube yükleme hatası: {ex}");
        }
        finally
        {
            IsLoadingBranches = false;
            StateHasChanged();
        }
    }



    private void OnStartTimeChanged()
    {
        if (TimeSpan.TryParse(startTimeString, out var time))
        {
            AppointmentModel.StartTime = time;
        }
        ValidateForm();
        StateHasChanged();
    }

    private void OnEndTimeChanged()
    {
        if (TimeSpan.TryParse(endTimeString, out var time))
        {
            AppointmentModel.EndTime = time;
        }
        ValidateForm();
        StateHasChanged();
    }

    private void ValidateForm()
    {
        validationError = string.Empty;

        if (AppointmentModel.EndTime <= AppointmentModel.StartTime)
        {
            validationError = "Bitiş saati, başlangıç saatinden sonra olmalıdır.";
            return;
        }

        if (AppointmentModel.Date < DateTime.Today)
        {
            validationError = "Talep tarihi bugünden önce olamaz.";
            return;
        }
    }

    private async Task HandleValidSubmit()
    {
        validationError = string.Empty;

        // Saat string'lerini TimeSpan'e çevir
        if (!string.IsNullOrWhiteSpace(startTimeString) && TimeSpan.TryParse(startTimeString, out var startTime))
        {
            AppointmentModel.StartTime = startTime;
        }
        else
        {
            Snackbar.Add("Başlangıç saati geçerli bir saat formatında olmalıdır.", Severity.Error);
            return;
        }
        
        if (!string.IsNullOrWhiteSpace(endTimeString) && TimeSpan.TryParse(endTimeString, out var endTime))
        {
            AppointmentModel.EndTime = endTime;
        }
        else
        {
            Snackbar.Add("Bitiş saati geçerli bir saat formatında olmalıdır.", Severity.Error);
            return;
        }

        // Doğrulama kuralları
        if (AppointmentModel.EndTime <= AppointmentModel.StartTime)
        {
            validationError = "Bitiş saati, başlangıç saatinden sonra olmalıdır.";
            Snackbar.Add(validationError, Severity.Error);
            return;
        }

        if (AppointmentModel.Date < DateTime.Today)
        {
            validationError = "Talep tarihi bugünden önce olamaz.";
            Snackbar.Add(validationError, Severity.Error);
            return;
        }

        if (AppointmentModel.BranchId <= 0)
        {
            validationError = "Şube seçimi zorunludur.";
            Snackbar.Add(validationError, Severity.Error);
            return;
        }

        IsSubmitting = true;
        try
        {
            // Başlık oluştur (eğer yoksa)
            if (string.IsNullOrWhiteSpace(AppointmentModel.Title))
            {
                var branch = Branches.FirstOrDefault(b => b.Id == AppointmentModel.BranchId);
                AppointmentModel.Title = $"{branch?.Name ?? "Randevu"} - {AppointmentModel.Date:dd.MM.yyyy}";
            }

            // Talep eden kullanıcı (gerçek uygulamada authentication'dan gelecek)
            if (string.IsNullOrWhiteSpace(AppointmentModel.RequestedBy))
            {
                AppointmentModel.RequestedBy = "Kullanıcı"; // Geçici
            }

            // Date'i UTC'ye çevir (PostgreSQL için)
            if (AppointmentModel.Date != DateTime.MinValue)
            {
                AppointmentModel.Date = DateTime.SpecifyKind(AppointmentModel.Date.Date, DateTimeKind.Utc);
            }

            await AppointmentService.CreateAppointmentAsync(AppointmentModel);
            Snackbar.Add("Randevu talebi başarıyla gönderildi!", Severity.Success);
            
            // Formu temizle
            AppointmentModel = new AppointmentDto();
            selectedBranchIdNullable = null;
            selectedDate = null;
            Location = string.Empty;
            startTimeString = string.Empty;
            endTimeString = string.Empty;
            validationError = string.Empty;
            
            // Listeye yönlendir
            await Task.Delay(1500);
            NavigationManager.NavigateTo("/appointments");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Hata: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsSubmitting = false;
            StateHasChanged();
        }
    }
}
